<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Lista de Tareas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h1 class="mb-4 text-center">Lista de Tareas</h1>

    <div class="d-flex justify-content-end mb-3">
        <a href="/tasks/new" class="btn btn-primary"
           sec:authorize="hasAuthority('PERMISSION_CREATE')">+ Nueva Tarea</a>
    </div>

    <table class="table table-striped table-bordered">
        <thead class="table-dark text-center">
        <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Descripción</th>
            <th>Fecha Límite</th>
            <th>Prioridad</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="task : ${tasks}">
            <td th:text="${task.id}"></td>
            <td th:text="${task.title}"></td>
            <td th:text="${task.description}"></td>
            <td th:text="${task.dueDate}"></td>
            <td>
                <span class="badge"
                      th:classappend="${task.priority == 'Alta' ? ' bg-danger' :
                                      (task.priority == 'Media' ? ' bg-warning text-dark' : ' bg-success')}">
                    [[${task.priority}]]
                </span>
            </td>
            <td th:text="${task.status}"></td>
            <td class="text-center">
                <div sec:authorize="hasAuthority('PERMISSION_DELETE')">
                    <button type="button" class="btn btn-danger btn-sm delete-task-btn"
                            th:data-task-id="${task.id}"
                            th:data-task-title="${task.title}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
                <div sec:authorize="!hasAuthority('PERMISSION_DELETE')">
                    <span class="text-muted">Sin permisos</span>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="mt-4 text-center">
        <a href="/home" class="btn btn-secondary">⬅ Volver al Home</a>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar la tarea "<span id="taskNameToDelete"></span>"?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let taskIdToDelete = null;

    // Agregar event listeners a los botones de eliminar
    document.addEventListener('DOMContentLoaded', function() {
        const deleteButtons = document.querySelectorAll('.delete-task-btn');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                const taskTitle = this.getAttribute('data-task-title');
                confirmDelete(taskId, taskTitle);
            });
        });
    });

    function confirmDelete(taskId, taskTitle) {
        taskIdToDelete = taskId;
        document.getElementById('taskNameToDelete').textContent = taskTitle;
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (taskIdToDelete) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/tasks/delete/${taskIdToDelete}`;
            document.body.appendChild(form);
            form.submit();
        }
    });
</script>

</body>
</html>
